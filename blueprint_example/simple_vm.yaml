tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/4.1/types.yaml
  - plugin.yaml

node_templates:

  vm_download:
    type: cloudify.nodes.ApplicationServer
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: scripts/download_vm.sh
          executor: central_deployment_agent

  vm_prepere:
    type: cloudify.nodes.ApplicationServer
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: scripts/copy_disk.sh
          executor: central_deployment_agent
          inputs:
            DISK: { get_attribute: [vm_download, vm_image] }
        delete:
          implementation: scripts/remove_disk.sh
          executor: central_deployment_agent
    relationships:
    - target: vm_download
      type: cloudify.relationships.depends_on

  common_network:
    type: cloudify.libvirt.network

  vm_impl:
    type: cloudify.libvirt.domain
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            params:
              memmory_size: 131072
              networks:
                - network: { get_attribute: [common_network, resource_id] }
                  mac: "52:54:00:23:fe:37"
                  dev: vnet0
                  name: net0
                  type: rtl8139
                  address:
                    function: "0x0"
                    type: pci
                    domain: "0x0000"
                    slot: "0x03"
                    bus: "0x00"
              disks:
                - dev: hda
                  bus: ide
                  file: { get_attribute: [vm_prepere, vm_image] }
                  type: qcow2
                  name: "ide-0-0-0-0"
                  address:
                    target: 0
                    unit: 0
                    bus: 0
                    controller: 0

    relationships:
    - target: common_network
      type: cloudify.libvirt.relationships.connected_to
    - target: vm_prepere
      type: cloudify.relationships.depends_on

